name: Deploy to khasinogaming.com

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        # Install any build tools if needed
        echo "No build dependencies required for static site"
        
    - name: Prepare deployment files
      run: |
        # Create deployment directory
        mkdir -p deploy
        
        # Copy all necessary files for the website
        cp index.html deploy/
        cp style.css deploy/
        cp script.js deploy/
        
        # Copy the pdf_images directory
        cp -r pdf_images deploy/
        
        # Create a simple .htaccess for better performance
        cat > deploy/.htaccess << 'EOF'
        # Enable compression
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/plain
            AddOutputFilterByType DEFLATE text/html
            AddOutputFilterByType DEFLATE text/xml
            AddOutputFilterByType DEFLATE text/css
            AddOutputFilterByType DEFLATE application/xml
            AddOutputFilterByType DEFLATE application/xhtml+xml
            AddOutputFilterByType DEFLATE application/rss+xml
            AddOutputFilterByType DEFLATE application/javascript
            AddOutputFilterByType DEFLATE application/x-javascript
            AddOutputFilterByType DEFLATE image/png
            AddOutputFilterByType DEFLATE image/jpg
            AddOutputFilterByType DEFLATE image/jpeg
        </IfModule>
        
        # Set cache headers for images
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType image/png "access plus 1 month"
            ExpiresByType image/jpg "access plus 1 month"
            ExpiresByType image/jpeg "access plus 1 month"
            ExpiresByType text/css "access plus 1 week"
            ExpiresByType application/javascript "access plus 1 week"
        </IfModule>
        
        # Security headers
        <IfModule mod_headers.c>
            Header always set X-Content-Type-Options nosniff
            Header always set X-Frame-Options DENY
            Header always set X-XSS-Protection "1; mode=block"
        </IfModule>
        EOF
        
        # Create a simple README for the deployed site
        cat > deploy/README.md << 'EOF'
        # The Birthday Book - PDF Image Gallery
        
        This is the deployed version of The Birthday Book, an interactive gallery showcasing 476 images extracted from PDF documents.
        
        ## Features
        - Interactive image gallery with filtering
        - Search functionality
        - Responsive design
        - Modal image viewing
        - Animated UI elements
        
        ## Access
        Visit: https://khasinogaming.com/birthdaybook
        
        ## Deployment
        This site is automatically deployed via GitHub Actions when changes are pushed to the main branch.
        EOF
        
        echo "Deployment files prepared successfully"
        ls -la deploy/
        
    - name: Deploy via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./deploy/
        server-dir: 
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.DS_Store
          **/Thumbs.db
          **/*.py
          **/*.md
          **/small_batch_results/**
          **/batch_results/**
          **/*.json
          **/*.txt
          **/*.bat
          **/*.pdf
          
    - name: Verify deployment
      run: |
        echo "Deployment completed successfully!"
        echo "Your site should be available at: https://khasinogaming.com/birthdaybook"
        echo "Please allow a few minutes for DNS propagation and server updates."
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ Deployment successful!"
          echo "🌐 Site URL: https://khasinogaming.com/birthdaybook"
        else
          echo "❌ Deployment failed!"
          echo "Please check the logs for more information."
        fi
